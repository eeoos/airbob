# --------------------------------------------------------
# Oracle Cloud VM.Standard.A1.Flex (ARM64) 배포용
# 4 OCPU / 24GB RAM
# --------------------------------------------------------
services:
  # --------------------------------------------------------
  # Nginx (Reverse Proxy + CORS + SSL)
  # --------------------------------------------------------
  nginx:
    image: nginx:1.25-alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - certbot-www:/var/www/certbot:ro
      - certbot-certs:/etc/letsencrypt:ro
    depends_on:
      app:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M
    restart: unless-stopped
    networks:
      - airbob-network

  # --------------------------------------------------------
  # Certbot (Let's Encrypt)
  # --------------------------------------------------------
  certbot:
    image: certbot/certbot:arm64v8-latest
    container_name: certbot
    volumes:
      - certbot-www:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    restart: unless-stopped
    networks:
      - airbob-network

  # --------------------------------------------------------
  # Spring Boot Application
  # --------------------------------------------------------
  app:
    image: eclipse-temurin:21-jre-alpine
    container_name: airbob-app
    working_dir: /app
    volumes:
      - ./build/libs/airbob.jar:/app/airbob.jar:ro
      - ./logs:/app/logs
    env_file:
      - .env.oci
    environment:
      # 프로필 및 JVM (env_file보다 우선)
      - SPRING_PROFILES_ACTIVE=oci
      - JAVA_OPTS=-Xms512m -Xmx1536m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
      # Docker 내부 서비스 주소 오버라이드
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/airbobdb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - REDIS_HOST=redis
      - ELASTICSEARCH_URIS=http://elasticsearch:9200
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    command: ["sh", "-c", "java $$JAVA_OPTS -jar airbob.jar"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 2G
    restart: unless-stopped
    networks:
      - airbob-network

  # --------------------------------------------------------
  # MySQL
  # --------------------------------------------------------
  mysql:
    image: mysql:8.0.33
    container_name: mysql
    env_file:
      - .env.oci
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: airbobdb
      MYSQL_USER: ${SPRING_DATASOURCE_USERNAME}
      MYSQL_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      TZ: UTC
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_0900_ai_ci
      - --server-id=1
      - --log-bin=mysql-bin
      - --binlog-format=ROW
      - --binlog-row-image=FULL
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 2G
    restart: unless-stopped
    networks:
      - airbob-network

  # --------------------------------------------------------
  # Kafka (Single Node - KRaft Mode)
  # --------------------------------------------------------
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: airbob-kafka-cluster
      # ARM64 메모리 최적화
      KAFKA_HEAP_OPTS: -Xms512m -Xmx1g
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1536M
    restart: unless-stopped
    networks:
      - airbob-network

  # --------------------------------------------------------
  # Debezium (Kafka Connect) - ARM64 빌드 사용
  # --------------------------------------------------------
  debezium:
    build:
      context: ./docker/debezium
      dockerfile: Dockerfile
    container_name: debezium
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: debezium-connect
      CONFIG_STORAGE_TOPIC: debezium_connect_configs
      OFFSET_STORAGE_TOPIC: debezium_connect_offsets
      STATUS_STORAGE_TOPIC: debezium_connect_statuses
      CONFIG_STORAGE_REPLICATION_FACTOR: 1
      OFFSET_STORAGE_REPLICATION_FACTOR: 1
      STATUS_STORAGE_REPLICATION_FACTOR: 1
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      HEAP_OPTS: -Xms256m -Xmx512m
    depends_on:
      kafka:
        condition: service_healthy
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 768M
    restart: unless-stopped
    networks:
      - airbob-network

  # --------------------------------------------------------
  # Elasticsearch (with Nori Analyzer)
  # --------------------------------------------------------
  elasticsearch:
    build:
      context: ./docker/elasticsearch
      dockerfile: Dockerfile
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
      - path.repo=/usr/share/elasticsearch/backup
    volumes:
      - es-data:/usr/share/elasticsearch/data
      - es-backup:/usr/share/elasticsearch/backup
    healthcheck:
      test: ["CMD", "curl", "-s", "http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 2G
    restart: unless-stopped
    networks:
      - airbob-network

  # --------------------------------------------------------
  # Redis
  # --------------------------------------------------------
  redis:
    image: redis:7.2-alpine
    container_name: redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 640M
    restart: unless-stopped
    networks:
      - airbob-network

# --------------------------------------------------------
# Volumes
# --------------------------------------------------------
volumes:
  mysql-data:
  kafka-data:
  es-data:
  es-backup:
  redis-data:
  certbot-www:
  certbot-certs:

# --------------------------------------------------------
# Networks
# --------------------------------------------------------
networks:
  airbob-network:
    driver: bridge
