input {
  jdbc {
    jdbc_driver_library => "/usr/share/logstash/config/jdbc/mysql-connector-j-8.0.33.jar"
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    #jdbc_connection_string => "jdbc:mysql://mysql:3306/airbobdb?serverTimezone=UTC&useSSL=false"
    jdbc_connection_string => "jdbc:mysql://mysql:3306/airbobdb?serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true"
    #jdbc_connection_string => "jdbc:mysql://mysql:3306/airbobdb?user=logstash&password=logstash&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
    jdbc_user => "logstash"
    jdbc_password => "logstash"

    jdbc_paging_enabled => true
    jdbc_page_size => 5000
    jdbc_fetch_size => 5000
    # 페이징 처리가 필요할 경우 jdbc_paging_enabled => true 설정 추가 고려
    # schedule => "* * * * *"

    statement => "
      SELECT
        BIN_TO_UUID(a.accommodation_uid) as id,
        a.id as accommodation_id,
        a.name,
        a.description,
        a.base_price,
        a.currency,
        a.type,
        a.status,
        a.created_at,
        a.thumbnail_url,

        -- Address (Location)
        ad.latitude,
        ad.longitude,
        ad.country,
        ad.state,
        ad.city,
        ad.district,
        ad.street,
        ad.detail as address_detail,
        ad.postal_code,

        -- Occupancy Policy
        op.max_occupancy as max_guests,
        op.infant_occupancy as max_infants,
        op.pet_occupancy as max_pets,

        -- Review Summary
        IFNULL(ars.total_review_count, 0) as review_count,
        IFNULL(ars.average_rating, 0.0) as average_rating,

        -- Amenities (Comma separated string)
        GROUP_CONCAT(DISTINCT am.name) as amenity_types_str

      FROM accommodation a
      LEFT JOIN address ad ON a.address_id = ad.id
      LEFT JOIN occupancy_policy op ON a.occupancy_policy_id = op.id
      LEFT JOIN accommodation_review_summary ars ON a.id = ars.accommodation_id
      LEFT JOIN accommodation_amenity aa ON a.id = aa.accommodation_id
      LEFT JOIN amenity am ON aa.amenity_id = am.id

      WHERE a.status = 'PUBLISHED'  -- 필요 시 삭제된 숙소 제외 등 필터 조건 추가
      GROUP BY a.id
    "
  }
}

filter {
  # 1. 데이터 타입 변환
  mutate {
    convert => {
      "latitude" => "float"
      "longitude" => "float"
      "average_rating" => "float"
      "review_count" => "integer"
      "base_price" => "integer"
      "max_guests" => "integer"
      "max_infants" => "integer"
      "max_pets" => "integer"
      "host_id" => "integer"
      "accommodation_id" => "integer"
    }
  }

  # 2. Location 객체 생성 (geo_point 형식: { "lat": ..., "lon": ... })
  if [latitude] and [longitude] {
    mutate {
      rename => {
        "latitude" => "[location][lat]"
        "longitude" => "[location][lon]"
      }
    }
  }

  # 3. 편의시설 문자열을 배열로 변환
  if [amenity_types_str] {
    mutate {
      split => { "amenity_types_str" => "," }
      rename => { "amenity_types_str" => "amenityTypes" }
    }
  }

  # 4. DB 컬럼명(snake_case)을 Document 필드명(camelCase)으로 매핑
  mutate {
    rename => {
      "base_price" => "basePrice"
      "created_at" => "createdAt"
      "thumbnail_url" => "thumbnailUrl"
      "address_detail" => "addressDetail"
      "postal_code" => "postalCode"
      "max_guests" => "maxGuests"
      "max_infants" => "maxInfants"
      "max_pets" => "maxPets"
      "host_id" => "hostId"
      "host_nickname" => "hostNickname"
      "review_count" => "reviewCount"
      "average_rating" => "averageRating"
      "accommodation_id" => "accommodationId"
    }
  }

  # 5. 불필요한 임시 필드 제거
  mutate {
    remove_field => ["@version", "@timestamp"]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "accommodations"
    document_id => "%{id}"
  }
  stdout { codec => json_lines }
}
